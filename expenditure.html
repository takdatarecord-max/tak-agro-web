<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Employee Expenditure - Tak Agro</title>

<style>
    body {
        font-family: Arial;
        background: #f3f4f6;
        padding: 15px;
    }
    .card {
        background: white;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label {
        font-weight: 600;
        margin-top: 10px;
        display: block;
    }
    input, select {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
    }

    /* Table Scroll */
    .table-wrapper {
        overflow-x: auto;
        border-radius: 10px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        min-width: 650px;
    }
    th, td {
        padding: 8px;
        border: 1px solid #ccc;
        white-space: nowrap;
    }
    th { background: #e5e7eb; }

    button {
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
    }

    .btn-primary { background: #2563eb; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-secondary { background: #6b7280; color: white; }

    .btn-small {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 20px;
    }

    /* SweetAlert Mobile Fix */
    .swal2-popup {
        width: 90% !important;
        max-width: 380px !important;
    }
    .swal2-input, .swal2-select {
        margin: 8px 0 !important;
        font-size: 15px !important;
    }
</style>
</head>

<body>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<h2>Employee Expenditure Entry</h2>

<a href="index.html">
    <button class="btn-secondary">⬅ Back</button>
</a>

<!-- ENTRY FORM -->
<div class="card">
    <label>Date</label>
    <input type="date" id="dateInput">

    <label>Employee</label>
    <select id="employeeSelect">
        <option value="">Select Employee</option>
    </select>

    <label>Description</label>
    <input type="text" id="descInput" placeholder="Expense detail...">

    <label>Amount (₹)</label>
    <input type="number" id="amountInput" placeholder="Amount">

    <button class="btn-primary" id="addBtn" onclick="addExpense()">Add Entry</button>
</div>

<!-- TABLE SECTION -->
<div class="card">
    <h3>Expenditure Records</h3>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Employee</th>
                    <th>Description</th>
                    <th>Amount (₹)</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody id="expenseBody"></tbody>
        </table>
    </div>

    <h3>Total Expenditure: ₹ <span id="totalAmt">0</span></h3>
</div>

<script type="module">
/* FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  deleteDoc, updateDoc, getDoc, doc
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyApcnzkckvflLeuEFozKfChcfE-x44ZDJ0",
    authDomain: "tak-agro.firebaseapp.com",
    projectId: "tak-agro",
    storageBucket: "tak-agro.firebasestorage.app",
    messagingSenderId: "153802937772",
    appId: "1:153802937772:web:abca377434d940d0b5ac69"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const employeesCol = collection(db, "employees");
const expenseCol   = collection(db, "employee_expenditures");

/* DOM */
const dateInput = document.getElementById("dateInput");
const employeeSelect = document.getElementById("employeeSelect");
const descInput = document.getElementById("descInput");
const amountInput = document.getElementById("amountInput");
const expenseBody = document.getElementById("expenseBody");
const totalAmtSpan = document.getElementById("totalAmt");
const addBtn = document.getElementById("addBtn");

dateInput.valueAsNumber = Date.now() - new Date().getTimezoneOffset()*60000;

let employees = {};
let editingId = null;

/* LOAD EMPLOYEES */
async function loadEmployees() {
    const snap = await getDocs(employeesCol);
    snap.forEach(e => {
        employees[e.id] = e.data().name;
        let opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = e.data().name;
        employeeSelect.appendChild(opt);
    });
}
loadEmployees();

/* ADD / UPDATE EXPENSE */
async function addExpense() {
    addBtn.disabled = true;
    let old = addBtn.textContent;
    addBtn.textContent = editingId ? "Updating..." : "Saving...";

    const date = dateInput.value;
    const emp  = employeeSelect.value;
    const desc = descInput.value.trim();
    const amt  = Number(amountInput.value);

    if (!date || !emp || !desc || !amt) {
        Swal.fire("Missing!", "Please fill all fields.", "warning");
        resetBtn();
        return;
    }

    try {
        if (editingId) {
            await updateDoc(doc(db, "employee_expenditures", editingId), {
                date, employeeId: emp, description: desc, amount: amt
            });
            Swal.fire("Updated!", "Expenditure updated.", "success");
        } else {
            await addDoc(expenseCol, {
                date, employeeId: emp, description: desc, amount: amt
            });
            Swal.fire("Saved!", "Expenditure added.", "success");
        }

        clearForm();
        editingId = null;
        addBtn.textContent = "Add Entry";

        loadExpenses();

    } catch (err) {
        Swal.fire("Error", err.message, "error");
    }

    resetBtn();
}

function resetBtn() {
    addBtn.disabled = false;
    addBtn.textContent = editingId ? "Update Entry" : "Add Entry";
}

function clearForm() {
    dateInput.value = "";
    employeeSelect.value = "";
    descInput.value = "";
    amountInput.value = "";
}

/* LOAD TABLE */
async function loadExpenses() {
    const snap = await getDocs(expenseCol);
    expenseBody.innerHTML = "";
    let total = 0;

    snap.forEach(item => {
        const d = item.data();
        total += d.amount;

        expenseBody.innerHTML += `
            <tr>
                <td>${d.date}</td>
                <td>${employees[d.employeeId] || "Unknown"}</td>
                <td>${d.description}</td>
                <td>₹${d.amount}</td>
                <td><button class="btn-secondary btn-small" onclick="editExpense('${item.id}')">Edit</button></td>
                <td><button class="btn-danger btn-small" onclick="deleteExpense('${item.id}')">Delete</button></td>
            </tr>
        `;
    });

    totalAmtSpan.textContent = total;
}
loadExpenses();

/* EDIT POPUP */
async function editExpense(id) {
    const snap = await getDoc(doc(db, "employee_expenditures", id));
    if (!snap.exists()) return;

    const d = snap.data();

    // Build employee dropdown HTML
    let empOptions = "";
    Object.keys(employees).forEach(eid => {
        empOptions += `<option value="${eid}" ${eid === d.employeeId ? "selected" : ""}>${employees[eid]}</option>`;
    });

    const { value: formData } = await Swal.fire({
        title: "Edit Expenditure",
        html: `
            <label style='font-size:12px;'>Date</label>
            <input id="sw_date" type="date" class="swal2-input" value="${d.date}">

            <label style='font-size:12px;'>Employee</label>
            <select id="sw_emp" class="swal2-select">${empOptions}</select>

            <label style='font-size:12px;'>Description</label>
            <input id="sw_desc" class="swal2-input" value="${d.description}">

            <label style='font-size:12px;'>Amount (₹)</label>
            <input id="sw_amt" type="number" class="swal2-input" value="${d.amount}">
        `,
        focusConfirm: false,
        confirmButtonText: "Save",
        showCancelButton: true,
        preConfirm: () => ({
            date: document.getElementById("sw_date").value,
            employeeId: document.getElementById("sw_emp").value,
            description: document.getElementById("sw_desc").value,
            amount: Number(document.getElementById("sw_amt").value)
        })
    });

    if (!formData) return;

    await updateDoc(doc(db, "employee_expenditures", id), formData);

    Swal.fire("Updated!", "Expenditure updated successfully.", "success");
    loadExpenses();
}

/* DELETE EXPENSE */
async function deleteExpense(id) {
    const confirm = await Swal.fire({
        title: "Delete Expense?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#dc2626",
        cancelButtonColor: "#6b7280",
        confirmButtonText: "Yes"
    });

    if (!confirm.isConfirmed) return;

    await deleteDoc(doc(db, "employee_expenditures", id));
    Swal.fire("Deleted!", "Entry removed.", "success");
    loadExpenses();
}

/* GLOBAL FUNCTIONS */
window.addExpense = addExpense;
window.editExpense = editExpense;
window.deleteExpense = deleteExpense;

</script>

</body>
</html>