<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tak Agro – Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f3f4f6;
    }
    .wrapper {
      max-width: 1100px;
      margin: auto;
      padding: 15px;
    }

    h1, h3 { margin-bottom: 10px; }

    .card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    label {
      font-weight: 600;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 5px 0 12px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
    }

    button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-primary   { background:#2563eb; color:white; }
    .btn-secondary { background:#6b7280; color:white; }
    .btn-small     { padding:5px 10px; font-size:12px; }

    /* Scrollable Table Box */
    .table-box {
      max-height: 260px;
      overflow-y: auto;
      overflow-x: auto;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      margin-top: 10px;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 650px;
      font-size: 13px;
    }

    th, td {
      padding: 6px;
      border: 1px solid #e5e7eb;
      white-space: nowrap;
    }

    th { background:#e5e7eb; }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: white;
      width: 90%;
      max-width: 450px;
      padding: 15px;
      border-radius: 10px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-close {
      float: right;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
    }

    .badge {
      padding: 2px 8px;
      background: #e5e7eb;
      border-radius: 8px;
      font-size: 12px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
<div class="wrapper">

  <h1>Tak Agro – Report (Invoice / Income / Expenditure)</h1>

  <a href="index.html"><button class="btn-secondary">⬅ Back to Dashboard</button></a>

  <!-- FILTERS -->
  <div class="card">
    <h3>Filters</h3>
    <div class="row">
      <div>
        <label>From Date</label>
        <input type="date" id="fromDate">
      </div>
      <div>
        <label>To Date</label>
        <input type="date" id="toDate">
      </div>
      <div>
        <label>Employee</label>
        <select id="filterEmployee"><option value="">All Employees</option></select>
      </div>
      <div>
        <label>Buyer</label>
        <select id="filterBuyer"><option value="">All Buyers</option></select>
      </div>
      <div>
        <label>Product</label>
        <select id="filterProduct"><option value="">All Products</option></select>
      </div>
    </div>

    <button class="btn-primary" id="generateBtn">Generate Report</button>
  </div>

  <!-- SUMMARY -->
  <div class="card">
    <h3>Summary</h3>
    <div class="row">
      <div><b>Invoice Total:</b> ₹ <span id="sumInvoiceAmount">0</span></div>
      <div><b>Income Total:</b> ₹ <span id="sumIncome">0</span></div>
      <div><b>Expenditure Total:</b> ₹ <span id="sumExpense">0</span></div>
      <div><b>Net:</b> ₹ <span id="sumNet">0</span></div>
    </div>
  </div>

  <!-- INVOICE REPORT -->
  <div class="card">
    <div class="section-header">
      <h3>Invoice Report <span class="badge" id="invoiceCountBadge">0 records</span></h3>
      <button class="btn-primary btn-small" id="invoicePdfBtn">Download PDF</button>
    </div>

    <div class="table-box">
      <table>
        <thead>
          <tr>
            <th>Invoice No</th>
            <th>Date</th>
            <th>Employee</th>
            <th>Buyer</th>
            <th>Amount (₹)</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="invoiceTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- INCOME REPORT -->
  <div class="card">
    <div class="section-header">
      <h3>Income Report <span class="badge" id="incomeCountBadge">0 records</span></h3>
      <button class="btn-primary btn-small" id="incomePdfBtn">Download PDF</button>
    </div>

    <div class="table-box">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Employee</th>
            <th>Description</th>
            <th>Amount (₹)</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="incomeTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- EXPENDITURE REPORT -->
  <div class="card">
    <div class="section-header">
      <h3>Expenditure Report <span class="badge" id="expenseCountBadge">0 records</span></h3>
      <button class="btn-primary btn-small" id="expensePdfBtn">Download PDF</button>
    </div>

    <div class="table-box">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Employee</th>
            <th>Description</th>
            <th>Amount (₹)</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="expenseTableBody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- MODAL -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <span class="modal-close" onclick="hideModal()">✕</span>
    <h3 id="modalTitle"></h3>
    <div id="modalContent"></div>
  </div>
</div>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
/* Firebase Imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

/* Firebase Init */
const app = initializeApp({
  apiKey: "AIzaSyApcnzkckvflLeuEFozKfChcfE-x44ZDJ0",
  authDomain: "tak-agro.firebaseapp.com",
  projectId: "tak-agro",
});
const db = getFirestore(app);

/* DOM Shortcuts */
const fromDateInput = fromDate;
const toDateInput = toDate;

const invoiceBody = invoiceTableBody;
const incomeBody  = incomeTableBody;
const expenseBody = expenseTableBody;

const invoiceCountBadge = document.getElementById("invoiceCountBadge");
const incomeCountBadge  = document.getElementById("incomeCountBadge");
const expenseCountBadge = document.getElementById("expenseCountBadge");

let employees={}, buyers={}, products={};
let invoiceData=[], incomeData=[], expenseData=[];

/* Load Master Data */
async function loadMasters(){
  const empSnap = await getDocs(collection(db,"employees"));
  empSnap.forEach(d=>{
    employees[d.id]=d.data().name;
    filterEmployee.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`;
  });

  const buySnap = await getDocs(collection(db,"buyers"));
  buySnap.forEach(d=>{
    buyers[d.id]=d.data().name;
    filterBuyer.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`;
  });

  const prodSnap = await getDocs(collection(db,"products"));
  prodSnap.forEach(d=>{
    products[d.id]=d.data().name;
    filterProduct.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`;
  });
}

/* Main Report Generator */
async function generateReport(){
  Swal.fire({title:"Loading...",allowOutsideClick:false,didOpen:()=>Swal.showLoading()});

  const from = fromDateInput.value;
  const to   = toDateInput.value;

  const entrySnap  = await getDocs(collection(db,"entries"));
  const incomeSnap = await getDocs(collection(db,"employee_income"));
  const expSnap    = await getDocs(collection(db,"employee_expenditures"));

  const emp = filterEmployee.value;
  const buy = filterBuyer.value;
  const pro = filterProduct.value;

  invoiceData = [];
  entrySnap.forEach(d=>{
    const x=d.data();
    if(x.date < from || x.date > to) return;
    if(emp && x.employeeId != emp) return;
    if(buy && x.buyerId != buy) return;
    if(pro){
      if(!(x.items||[]).some(i=>i.productId==pro)) return;
    }
    invoiceData.push({id:d.id,...x});
  });

  incomeData=[];
  incomeSnap.forEach(d=>{
    const x=d.data();
    if(x.date<from || x.date>to) return;
    if(emp && x.employeeId!=emp) return;
    incomeData.push({id:d.id,...x});
  });

  expenseData=[];
  expSnap.forEach(d=>{
    const x=d.data();
    if(x.date<from || x.date>to) return;
    if(emp && x.employeeId!=emp) return;
    expenseData.push({id:d.id,...x});
  });

  renderTables();
  Swal.close();
}

/* Render Tables */
function renderTables(){
  /* INVOICE */
  invoiceBody.innerHTML="";
  let invTotal=0;
  invoiceData.forEach(inv=>{
    invTotal+=Number(inv.totalAmount||0);
    invoiceBody.innerHTML+=`
      <tr>
        <td>${inv.billNo}</td>
        <td>${inv.date}</td>
        <td>${employees[inv.employeeId]||"-"}</td>
        <td>${buyers[inv.buyerId]||"-"}</td>
        <td>₹${inv.totalAmount}</td>
        <td><button class="btn-small btn-secondary" onclick="viewInvoice('${inv.id}')">View</button></td>
      </tr>`;
  });
  invoiceCountBadge.textContent=`${invoiceData.length} records`;

  /* INCOME */
  incomeBody.innerHTML="";
  let incTotal=0;
  incomeData.forEach(x=>{
    incTotal+=Number(x.amount||0);
    incomeBody.innerHTML+=`
      <tr>
        <td>${x.date}</td>
        <td>${employees[x.employeeId]||"-"}</td>
        <td>${x.description}</td>
        <td>₹${x.amount}</td>
        <td><button class="btn-small btn-secondary" onclick="viewIncome('${x.id}')">View</button></td>
      </tr>`;
  });
  incomeCountBadge.textContent=`${incomeData.length} records`;

  /* EXPENSE */
  expenseBody.innerHTML="";
  let expTotal=0;
  expenseData.forEach(x=>{
    expTotal+=Number(x.amount||0);
    expenseBody.innerHTML+=`
      <tr>
        <td>${x.date}</td>
        <td>${employees[x.employeeId]||"-"}</td>
        <td>${x.description}</td>
        <td>₹${x.amount}</td>
        <td><button class="btn-small btn-secondary" onclick="viewExpense('${x.id}')">View</button></td>
      </tr>`;
  });
  expenseCountBadge.textContent=`${expenseData.length} records`;

  /* SUMMARY */
  sumInvoiceAmount.textContent = invTotal.toFixed(2);
  sumIncome.textContent = incTotal.toFixed(2);
  sumExpense.textContent = expTotal.toFixed(2);
  sumNet.textContent = (invTotal + incTotal - expTotal).toFixed(2);
}

/* Modal Functions */
window.hideModal=()=>modalBackdrop.style.display="none";

window.viewInvoice=function(id){
  const x=invoiceData.find(a=>a.id==id);
  if(!x) return;
  modalTitle.innerText="Invoice Details";
  modalContent.innerHTML=`
    <p><b>Invoice No:</b> ${x.billNo}</p>
    <p><b>Date:</b> ${x.date}</p>
    <p><b>Employee:</b> ${employees[x.employeeId]||"-"}</p>
    <p><b>Buyer:</b> ${buyers[x.buyerId]||"-"}</p>
    <hr><b>Items:</b><br><br>
    ${x.items.map(i=>`<div><b>${i.productName}</b> — Qty:${i.qty}, Weight:${i.totalWeight}, Amount:₹${i.amount}</div>`).join("")}
    <hr><p><b>Total:</b> ₹${x.totalAmount}</p>`;
  modalBackdrop.style.display="flex";
};

window.viewIncome=function(id){
  const x=incomeData.find(a=>a.id==id);
  modalTitle.innerText="Income Details";
  modalContent.innerHTML=`
    <p><b>Date:</b> ${x.date}</p>
    <p><b>Employee:</b> ${employees[x.employeeId]||"-"}</p>
    <p><b>Description:</b> ${x.description}</p>
    <p><b>Amount:</b> ₹${x.amount}</p>`;
  modalBackdrop.style.display="flex";
};

window.viewExpense=function(id){
  const x=expenseData.find(a=>a.id==id);
  modalTitle.innerText="Expenditure Details";
  modalContent.innerHTML=`
    <p><b>Date:</b> ${x.date}</p>
    <p><b>Employee:</b> ${employees[x.employeeId]||"-"}</p>
    <p><b>Description:</b> ${x.description}</p>
    <p><b>Amount:</b> ₹${x.amount}</p>`;
  modalBackdrop.style.display="flex";
};


/* Init */
await loadMasters();
await generateReport();

generateBtn.addEventListener("click", generateReport);
invoicePdfBtn.addEventListener("click", ()=>Swal.fire("PDF","Invoice PDF under development.","info"));
incomePdfBtn.addEventListener("click", ()=>Swal.fire("PDF","Income PDF under development.","info"));
expensePdfBtn.addEventListener("click", ()=>Swal.fire("PDF","Expense PDF under development.","info"));

</script>
</body>
</html>