<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tak Agro Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin:0;
      font-family: "Poppins", Arial, sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top left, #bfdbfe 0, #e0f2fe 35%, #f9fafb 80%);
      color:#0f172a;
    }

    body::before,
    body::after {
      content:"";
      position:fixed;
      width:260px;
      height:260px;
      border-radius:999px;
      filter:blur(70px);
      opacity:.7;
      z-index:-1;
    }
    body::before {
      top:-80px;
      left:-60px;
      background:#93c5fd;
    }
    body::after {
      bottom:-90px;
      right:-40px;
      background:#f9a8d4;
    }

    .sidebar {
      width:250px;
      height:100vh;
      position:fixed;
      left:0;
      top:0;
      padding:78px 14px 18px;
      background:rgba(255,255,255,0.22);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-right:1px solid rgba(148,163,184,0.55);
      box-shadow:10px 0 25px rgba(15,23,42,0.18);
      border-radius:0 24px 24px 0;
      transition:transform .3s ease;
      z-index:10;
      color:#0f172a;
    }

    .sidebar h2 {
      text-align:center;
      margin:0 0 16px 0;
      font-size:19px;
      letter-spacing:0.06em;
      text-transform:uppercase;
      color:#1e293b;
    }

    .sidebar a {
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      margin-bottom:6px;
      color:#111827;
      text-decoration:none;
      font-size:14px;
      border-radius:12px;
      transition:0.2s;
    }

    .sidebar a:hover {
      background:rgba(59,130,246,0.12);
      transform:translateX(4px);
    }

    @media(max-width:768px){
      .sidebar { transform:translateX(-260px); }
      .sidebar.open { transform:translateX(0); }
    }

    .topbar {
      position:fixed;
      top:0;
      left:0;
      right:0;
      height:60px;
      background:rgba(255,255,255,0.78);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(148,163,184,0.6);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      box-shadow:0 10px 25px rgba(15,23,42,0.15);
      z-index:20;
    }

    .topbar-left {
      display:flex;
      align-items:center;
      gap:10px;
    }

    .menu-btn {
      font-size:26px;
      cursor:pointer;
      display:none;
    }
    @media(max-width:768px){
      .menu-btn { display:block; }
    }

    .topbar-logo {
      width:34px;
      height:34px;
      border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#38bdf8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#f9fafb;
      font-size:17px;
      font-weight:700;
      box-shadow:0 6px 14px rgba(37,99,235,0.6);
    }

    .topbar-title {
      font-size:18px;
      font-weight:600;
      line-height:1.2;
    }

    .topbar-sub {
      font-size:11px;
      color:#6b7280;
    }

    .profile-icon {
      width:40px;
      height:40px;
      border-radius:50%;
      border:2px solid #e5e7eb;
      cursor:pointer;
      object-fit:cover;
      box-shadow:0 4px 12px rgba(15,23,42,0.25);
    }

    .profile-menu {
      position:absolute;
      right:18px;
      top:64px;
      width:210px;
      background:rgba(255,255,255,0.95);
      backdrop-filter: blur(14px);
      border-radius:16px;
      box-shadow:0 16px 36px rgba(15,23,42,0.3);
      overflow:hidden;
      display:none;
      z-index:30;
      border:1px solid rgba(148,163,184,0.6);
    }

    .profile-menu div {
      padding:11px 14px;
      font-size:14px;
      border-bottom:1px solid #e5e7eb;
      cursor:pointer;
    }
    .profile-menu div:last-child { border-bottom:none; }
    .profile-menu div:hover { background:#eef2ff; }

    .main {
      margin-left:250px;
      padding:86px 20px 20px;
      transition:.3s;
    }
    @media(max-width:768px){
      .main { margin-left:0; padding-top:80px; }
    }

    .dashboard-grid {
      margin-top:22px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:14px;
    }

    .card {
      position:relative;
      padding:14px 12px;
      border-radius:16px;
      background:rgba(255,255,255,0.3);
      border:1px solid rgba(148,163,184,0.7);
      backdrop-filter: blur(16px);
      box-shadow:0 10px 24px rgba(15,23,42,0.18);
      cursor:pointer;
      transition:0.2s;
      min-height:105px;
      overflow:hidden;
    }

    .card:hover {
      transform:translateY(-3px);
      box-shadow:0 16px 32px rgba(15,23,42,0.22);
    }

    .card-icon { font-size:22px; margin-bottom:6px; }
    .card-title { font-size:14px; font-weight:600; }
    .card-sub { font-size:11px; color:#6b7280; }
  </style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-left">
    <span class="menu-btn" onclick="toggleSidebar()">‚ò∞</span>

    <div class="topbar-logo">TA</div>
    <div>
      <div class="topbar-title">Tak Agro</div>
      <div class="topbar-sub">Owner Dashboard</div>
    </div>
  </div>

  <img id="profileIcon" class="profile-icon"
       src="https://cdn-icons-png.flaticon.com/512/149/149071.png"
       onclick="toggleProfileMenu()">
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <h2>Tak Agro</h2>
  <a href="index.html">üè† Dashboard</a>
  <a href="employee.html">üë∑ Employee</a>
  <a href="buyer.html">üõí Buyer</a>
  <a href="product.html">üì¶ Product</a>
  <a href="entry.html">üìù Entry</a>
  <a href="income.html">üí∞ Income</a>
  <a href="expenditure.html">üßæ Expenditure</a>
  <a href="report.html">üìä Report</a>
</div>

<!-- PROFILE MENU -->
<div id="profileMenu" class="profile-menu">
  <div onclick="viewProfile()">üëÄ My Profile</div>
  <div onclick="changePassword()">üîë Change Password</div>
  <div onclick="logoutUser()">üö™ Logout</div>
</div>

<!-- MAIN CONTENT -->
<div class="main">

  <h1>Welcome to Tak Agro üëã</h1>
  <p>Select a module from the cards or sidebar.</p>

  <div class="dashboard-grid">

    <div class="card" onclick="location.href='employee.html'">
      <div class="card-icon">üë∑</div>
      <div class="card-title">Employees</div>
      <div class="card-sub">Add & manage staff</div>
    </div>

    <div class="card" onclick="location.href='buyer.html'">
      <div class="card-icon">üõí</div>
      <div class="card-title">Buyers</div>
      <div class="card-sub">Manage your buyers</div>
    </div>

    <div class="card" onclick="location.href='product.html'">
      <div class="card-icon">üì¶</div>
      <div class="card-title">Products</div>
      <div class="card-sub">Product master list</div>
    </div>

    <div class="card" onclick="location.href='entry.html'">
      <div class="card-icon">üìù</div>
      <div class="card-title">Entries</div>
      <div class="card-sub">Create new entries</div>
    </div>

    <div class="card" onclick="location.href='income.html'">
      <div class="card-icon">üí∞</div>
      <div class="card-title">Income</div>
      <div class="card-sub">Record incomes</div>
    </div>

    <div class="card" onclick="location.href='expenditure.html'">
      <div class="card-icon">üßæ</div>
      <div class="card-title">Expenditure</div>
      <div class="card-sub">Track expenses</div>
    </div>

    <div class="card" onclick="location.href='report.html'">
      <div class="card-icon">üìä</div>
      <div class="card-title">Reports</div>
      <div class="card-sub">View summaries</div>
    </div>

  </div>
</div>

<!-- FIREBASE -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut, updatePassword
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

import {
  getFirestore, doc, getDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyApcn2ckkvfLaEuKEKOZfC6hcEfx44ZDJ0",
  authDomain: "tak-agro.firebaseapp.com",
  projectId: "tak-agro",
  storageBucket: "tak-agro.firebasestorage.app",
  messagingSenderId: "158309293772",
  appId: "1:158309293772:web:ebca377434d940d0b5ac69"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const OWNER_EMAIL = "bhuraramtak81@gmail.com";

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "login.html";

  if (user.email !== OWNER_EMAIL) {
    await signOut(auth);
    return window.location.href = "login.html";
  }

  const localSessionId = localStorage.getItem("ownerSessionId");
  if (!localSessionId) {
    await signOut(auth);
    Swal.fire("Session Error", "Please login again.", "warning");
    return window.location.href = "login.html";
  }

  // ‚≠ê UPDATED POPUP-FIRST SESSION CHECK ‚≠ê
  const sessRef = doc(db, "sessions", "owner");
  onSnapshot(sessRef, async (snap) => {
    if (!snap.exists()) return;

    const serverId = snap.data().sessionId;

    if (serverId !== localSessionId) {

      // üî• 1. Popup FIRST
      await Swal.fire({
        title: "Session Expired",
        text: "Your account was logged in from another device.",
        icon: "warning",
        confirmButtonText: "OK"
      });

      // üî• 2. Logout
      await signOut(auth);
      localStorage.removeItem("ownerSessionId");

      // üî• 3. Redirect
      window.location.href = "login.html";
    }
  });

  try {
    const snap = await getDoc(doc(db, "profiles", "owner"));
    if (snap.exists() && snap.data().photoURL)
      document.getElementById("profileIcon").src = snap.data().photoURL;
  } catch (e) {}
});

window.toggleSidebar = () => {
  document.getElementById("sidebar").classList.toggle("open");
};
window.toggleProfileMenu = () => {
  const pm = document.getElementById("profileMenu");
  pm.style.display = pm.style.display === "block" ? "none" : "block";
};
window.viewProfile = () => window.location.href = "profile.html";

window.changePassword = async () => {
  const { value: newPass } = await Swal.fire({
    title: "New Password",
    input: "password",
    showCancelButton: true,
    confirmButtonText: "Update"
  });

  if (!newPass) return;
  if (newPass.length < 6) return Swal.fire("Error", "Password must be at least 6 characters.", "error");

  try {
    await updatePassword(auth.currentUser, newPass);
    Swal.fire("Done!", "Password updated.", "success");
  } catch (err) {
    Swal.fire("Error", err.message, "error");
  }
};

window.logoutUser = async () => {
  const out = await Swal.fire({
    title:"Logout?",
    showCancelButton:true,
    confirmButtonText:"Logout"
  });

  if (!out.isConfirmed) return;

  await signOut(auth);
  localStorage.removeItem("ownerSessionId");
  window.location.href = "login.html";
};

window.addEventListener("click", (e) => {
  const menu = document.getElementById("profileMenu");
  const icon = document.getElementById("profileIcon");
  if (e.target === icon) return;
  if (!menu.contains(e.target)) menu.style.display = "none";
});

</script>

</body>
</html>
