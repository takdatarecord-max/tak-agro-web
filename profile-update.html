<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tak Agro â€“ Update Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body{
        margin:0; padding:15px; background:#f3f4f6; font-family:Arial;
    }
    .card{
        max-width:450px; margin:auto; background:white;
        padding:20px; border-radius:12px;
        box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .profile-preview{
        width:130px; height:130px; border-radius:50%;
        display:block; margin:auto; object-fit:cover;
        border:3px solid #ddd;
    }
    label{ font-weight:600; margin-top:10px; display:block; }
    input{
        width:100%; padding:10px; margin-top:5px; border-radius:6px;
        border:1px solid #ccc;
    }
    button{
        width:100%; padding:12px; margin-top:15px;
        background:#2563eb; color:white;
        border:none; border-radius:6px;
        font-size:16px; cursor:pointer;
    }
    button:hover{ background:#1d4ed8; }

    .back{
        display:block; margin-top:12px; background:#6b7280;
        padding:10px; color:white; text-align:center;
        border-radius:6px; text-decoration:none;
    }
</style>
</head>

<body>
<div class="card">

    <h2 style="text-align:center;">Update Profile</h2>

    <img id="imgPreview"
         class="profile-preview"
         src="https://cdn-icons-png.flaticon.com/512/149/149071.png">

    <label>Profile Photo</label>
    <input type="file" id="photoFile" accept="image/*">

    <label>Name</label>
    <input type="text" id="nameInput" placeholder="Your Name">

    <button onclick="saveProfile()">Save Profile</button>

    <a href="index.html" class="back">â¬… Back to Dashboard</a>

</div>

<script type="module">

/* ðŸ”¥ Firebase Imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

/* ðŸ”¥ Your Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyApcn2ckkvfLaEuKEKOZfC6hcEfx44ZDJ0",
  authDomain: "tak-agro.firebaseapp.com",
  projectId: "tak-agro",
  storageBucket: "tak-agro.firebasestorage.app",
  messagingSenderId: "158309293772",
  appId: "1:158309293772:web:ebca377434d940d0b5ac69"
};

const app      = initializeApp(firebaseConfig);
const auth     = getAuth(app);
const db       = getFirestore(app);
const storage  = getStorage(app);

let oldPhotoURL = "";

/* ---------------- LOAD OLD PROFILE ---------------- */
onAuthStateChanged(auth, async (user)=>{
    if(!user) return location.href = "login.html";

    const snap = await getDoc(doc(db, "profiles", "owner"));
    if (snap.exists()) {
        const d = snap.data();

        if (d.name) document.getElementById("nameInput").value = d.name;
        if (d.photoURL) {
            oldPhotoURL = d.photoURL;
            document.getElementById("imgPreview").src = d.photoURL;
        }
    }
});

/* ---------------- IMAGE PREVIEW ---------------- */
document.getElementById("photoFile").addEventListener("change", (e)=>{
    const file = e.target.files[0];
    if (file) {
        document.getElementById("imgPreview").src = URL.createObjectURL(file);
    }
});

/* ---------------- SAVE PROFILE ---------------- */
window.saveProfile = async function() {

    const name = document.getElementById("nameInput").value.trim();
    const file = document.getElementById("photoFile").files[0];

    if (!name) {
        return Swal.fire("Missing!", "Name is required", "warning");
    }

    Swal.fire({ title:"Saving...", allowOutsideClick:false });
    Swal.showLoading();

    let photoURL = oldPhotoURL;

    try {

        /* Upload new image if selected */
        if (file) {
            const r = ref(storage, "profile/owner.jpg");
            await uploadBytes(r, file);
            photoURL = await getDownloadURL(r);
        }

        /* Save Firestore */
        await setDoc(doc(db, "profiles", "owner"), {
            name,
            photoURL
        }, { merge:true });

        Swal.fire("Success", "Profile updated successfully!", "success")
            .then(()=> location.href = "index.html");

    } catch(err) {
        console.log(err);
        Swal.fire("Error", err.message, "error");
    }
};
</script>

</body>
</html>