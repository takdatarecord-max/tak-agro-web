<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Product Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    padding: 20px;
    font-family: "Poppins", sans-serif;
    color: #0f172a;
    min-height: 100vh;
    background: radial-gradient(circle at top left, #93c5fd 0, #dbeafe 40%, #f1f5f9 80%);
  }

  body::before,
  body::after {
    content:"";
    position:fixed;
    width:240px;
    height:240px;
    border-radius:999px;
    filter:blur(60px);
    opacity:0.45;
    z-index:-1;
  }
  body::before { top:-60px; left:-40px; background:#60a5fa; }
  body::after  { bottom:-70px; right:-30px; background:#f472b6; }

  .wrapper { max-width:1050px; margin:auto; }

  /* HEADER */
  .page-header {
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:16px;
    padding:10px 0;
  }
  .page-header-icon { font-size:28px; }
  .page-title { font-size:22px; font-weight:700; }

  .back-btn {
    padding:8px 18px;
    border-radius:999px;
    background:rgba(255,255,255,0.6);
    border:1px solid rgba(148,163,184,0.4);
    cursor:pointer;
    font-size:13px;
    margin-bottom:14px;
  }

  /* CARD */
  .card {
    background:rgba(255,255,255,0.65);
    backdrop-filter:blur(12px);
    border:1px solid rgba(148,163,184,0.45);
    border-radius:18px;
    padding:18px;
    margin-bottom:18px;
    box-shadow:0 6px 18px rgba(0,0,0,0.15);
  }

  .card-title { font-size:17px; font-weight:600; margin-bottom:10px; }

  /* FORM */
  .form-row {
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }
  .form-row > div {
    flex:1;
    min-width:240px;
    max-width:320px;
  }

  input[type="text"],
  select {
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(148,163,184,0.6);
    background:rgba(255,255,255,0.7);
    font-size:14px;
  }

  input:focus,
  select:focus {
    outline:none;
    border-color:#2563eb;
    box-shadow:0 0 0 1px rgba(37,99,235,0.2);
  }

  /* SAVE BUTTON + LOADING */
  #saveBtn {
    margin-top:10px;
    padding:10px 18px;
    font-size:15px;
    border-radius:12px;
    background:linear-gradient(135deg,#2563eb,#38bdf8);
    color:white;
    border:none;
    cursor:pointer;
  }

  #loadingIcon {
    display:none;
    margin-top:10px;
    font-size:14px;
    color:#2563eb;
  }

  .spinner {
    width:18px;
    height:18px;
    border:3px solid #e5e7eb;
    border-top:3px solid #2563eb;
    border-radius:50%;
    animation:spin 0.7s linear infinite;
    display:inline-block;
  }
  @keyframes spin { 100% { transform:rotate(360deg); } }

  /* TABLE */
  table {
    width:100%;
    border-collapse:collapse;
    background:rgba(255,255,255,0.55);
    backdrop-filter:blur(10px);
    border:1px solid rgba(148,163,184,0.45);
    border-radius:12px;
    overflow:hidden;
    text-align:center;
  }

  th, td {
    padding:10px;
    border-bottom:1px solid rgba(148,163,184,0.35);
    text-align:center;
  }

  thead { background:rgba(255,255,255,0.75); font-weight:600; }
  tr:hover td { background:rgba(255,255,255,0.8); }

  .btn-sm {
    padding:5px 12px;
    font-size:12px;
    border-radius:999px;
    border:none;
    cursor:pointer;
  }

  .edit-btn {
    background:#3b82f6;
    color:white;
  }
  .delete-btn {
    background:#dc2626;
    color:white;
  }

  /* SWEETALERT GLASS THEME */
  .swal2-popup {
    background:rgba(255,255,255,0.7) !important;
    backdrop-filter:blur(14px) !important;
    border-radius:18px !important;
    border:1px solid rgba(148,163,184,0.45) !important;
  }
</style>
</head>

<body>
<div class="wrapper">

  <div class="page-header">
    <div class="page-header-icon">üì¶</div>
    <div class="page-title">Product Management</div>
  </div>

  <button class="back-btn" onclick="location.href='index.html'">‚¨Ö Back</button>

  <!-- ADD / EDIT PRODUCT -->
  <div class="card">
    <div class="card-title">Add / Edit Product</div>

    <input type="hidden" id="productId">

    <div class="form-row">
      <div>
        <label>Category</label>
        <select id="p_category">
          <option value="">Select Category</option>
          <option value="Vegetable">Vegetable</option>
          <option value="Crop">Crop</option>
          <option value="Fruit">Fruit</option>
        </select>
      </div>

      <div>
        <label>Product Name</label>
        <select id="p_name" disabled>
          <option value="">Select Category first</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Unit (‡§á‡§ï‡§æ‡§à)</label>
        <select id="p_unit">
          <option value="">Select Unit</option>
          <option value="Kg">Kg</option>
          <option value="Gram">Gram</option>
          <option value="Litre">Litre</option>
          <option value="ml">ml</option>
          <option value="Piece">Piece</option>
          <option value="Bag">Bag</option>
          <option value="Packet">Packet</option>
        </select>
      </div>
    </div>

    <button id="saveBtn">üíæ Save</button>
    <div id="loadingIcon"><span class="spinner"></span> Saving...</div>
  </div>

  <!-- PRODUCT LIST -->
  <div class="card">
    <div class="card-title">Product List</div>

    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Product Name</th>
            <th>Unit</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  updateDoc, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyApcnzkckvflLeuEFozKfChcfE-x44ZDJ0",
  authDomain: "tak-agro.firebaseapp.com",
  projectId: "tak-agro",
  storageBucket: "tak-agro.firebasestorage.app",
  messagingSenderId: "153802937772",
  appId: "1:153802937772:web:abca377434d940d0b5ac69"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const productCol = collection(db,"products");

const saveBtn = document.getElementById("saveBtn");
const loadingIcon = document.getElementById("loadingIcon");
const tableBody = document.getElementById("tableBody");
const catSelect = document.getElementById("p_category");
const nameSelect = document.getElementById("p_name");
const unitSelect = document.getElementById("p_unit");

/* üîπ CATEGORY ‚Üí PRODUCT NAME MAP */
const CATEGORY_PRODUCTS = {
  "Vegetable": [
    "Potato (‡§Ü‡§≤‡•Ç)",
    "Tomato (‡§ü‡§Æ‡§æ‡§ü‡§∞)",
    "Onion (‡§™‡•ç‡§Ø‡§æ‡§ú‡§º)",
    "Garlic (‡§≤‡§π‡§∏‡•Å‡§®)",
    "Cauliflower (‡§ó‡•ã‡§≠‡•Ä)",
    "Cabbage (‡§™‡§§‡•ç‡§§‡§æ‡§ó‡•ã‡§≠‡•Ä)",
    "Brinjal (‡§¨‡•à‡§Ç‡§ó‡§®)",
    "Lady Finger (‡§≠‡§ø‡§Ç‡§°‡•Ä)",
    "Carrot (‡¶ó‡§æ‡§ú‡§∞)",
    "Peas (‡§Æ‡§ü‡§∞)",
    "Spinach (‡§™‡§æ‡§≤‡§ï)",
    "Bottle Gourd (‡§≤‡•å‡§ï‡•Ä)",
    "Bitter Gourd (‡§ï‡§∞‡•á‡§≤‡§æ)",
    "Green Chili (‡§π‡§∞‡•Ä ‡§Æ‡§ø‡§∞‡•ç‡§ö)"
  ],
  "Crop": [
    "Wheat (‡§ó‡•á‡§π‡•Ç‡§Å)",
    "Mustard (‡§∏‡§∞‡§∏‡•ã‡§Ç)",
    "Corn (‡§Æ‡§ï‡•ç‡§ï‡§æ)",
    "Bajra (‡§¨‡§æ‡§ú‡§∞‡§æ)",
    "Barley (‡§ú‡•å)",
    "Soybean (‡§∏‡•ã‡§Ø‡§æ‡§¨‡•Ä‡§®)",
    "Cotton (‡§ï‡§™‡§æ‡§∏)",
    "Sugarcane (‡§ó‡§®‡•ç‡§®‡§æ)",
    "Groundnut (‡§Æ‡•Ç‡§Ç‡§ó‡§´‡§≤‡•Ä)",
    "Sunflower (‡§∏‡•Ç‡§∞‡§ú‡§Æ‡•Å‡§ñ‡•Ä)"
  ],
  "Fruit": [
    "Mango (‡§Ü‡§Æ)",
    "Banana (‡§ï‡•á‡§≤‡§æ)",
    "Orange (‡§∏‡§Ç‡§§‡§∞‡§æ)",
    "Papaya (‡§™‡§™‡•Ä‡§§‡§æ)",
    "Grapes (‡§Ö‡§Ç‡§ó‡•Ç‡§∞)",
    "Apple (‡§∏‡•á‡§¨)"
  ]
};

/* COMMON FUNCTION ‚Üí Fill any product <select> based on category */
function populateProductSelect(category, selectEl, selectedValue = "") {
  selectEl.innerHTML = "";

  if (!category) {
    selectEl.disabled = true;
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Select Category first";
    selectEl.appendChild(opt);
    return;
  }

  const list = CATEGORY_PRODUCTS[category] || [];
  selectEl.disabled = false;

  const def = document.createElement("option");
  def.value = "";
  def.textContent = "Select Product";
  selectEl.appendChild(def);

  list.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    if (p === selectedValue) opt.selected = true;
    selectEl.appendChild(opt);
  });

  // if editing & previous product not in list, add it
  if (selectedValue && !list.includes(selectedValue)) {
    const extra = document.createElement("option");
    extra.value = selectedValue;
    extra.textContent = selectedValue;
    extra.selected = true;
    selectEl.appendChild(extra);
  }
}

/* MAIN FORM: when category changes ‚Üí update product list */
catSelect.addEventListener("change", () => {
  populateProductSelect(catSelect.value, nameSelect);
});

/* LOADING */
function startLoad(){
  saveBtn.style.display = "none";
  loadingIcon.style.display = "block";
}
function stopLoad(){
  saveBtn.style.display = "inline-block";
  loadingIcon.style.display = "none";
}

/* DUPLICATE CHECK (Category + Name + Unit) */
async function duplicateProductCheck(category, name, unit, excludeId = null) {
  const snap = await getDocs(productCol);
  let dup = false;

  snap.forEach(docSnap => {
    const d = docSnap.data();
    if (
      docSnap.id !== excludeId &&
      d.category === category &&
      d.name === name &&
      d.unit === unit
    ) {
      dup = true;
    }
  });
  return dup;
}

/* LOAD TABLE */
async function loadProducts(){
  tableBody.innerHTML = "";
  const snap = await getDocs(productCol);

  snap.forEach(docSnap => {
    const d = docSnap.data();

    tableBody.innerHTML += `
      <tr>
        <td>${d.category}</td>
        <td>${d.name}</td>
        <td>${d.unit}</td>
        <td>
          <button class="btn-sm edit-btn"
            onclick="editProduct('${docSnap.id}','${d.category}','${d.name}','${d.unit}')">Edit</button>
          <button class="btn-sm delete-btn"
            onclick="deleteProduct('${docSnap.id}')">Delete</button>
        </td>
      </tr>`;
  });
}

/* EDIT POPUP: Category + ProductName dropdown + Unit dropdown */
window.editProduct = async function (id, category, name, unit) {
  const { value: data } = await Swal.fire({
    title: "Edit Product",
    html: `
      <label style="font-weight:700;font-size:13px;">Category</label>
      <select id="sw_category" class="swal2-input" style="height:auto;padding:8px 10px;">
        <option value="">Select Category</option>
        <option value="Vegetable" ${category==="Vegetable"?"selected":""}>Vegetable</option>
        <option value="Crop" ${category==="Crop"?"selected":""}>Crop</option>
        <option value="Fruit" ${category==="Fruit"?"selected":""}>Fruit</option>
      </select>

      <label style="font-weight:700;font-size:13px;">Product Name</label>
      <select id="sw_name" class="swal2-input" style="height:auto;padding:8px 10px;">
        <option value="">Select Category first</option>
      </select>

      <label style="font-weight:700;font-size:13px;">Unit</label>
      <select id="sw_unit" class="swal2-input" style="height:auto;padding:8px 10px;">
        <option value="">Select Unit</option>
        <option value="Kg" ${unit==="Kg"?"selected":""}>Kg</option>
        <option value="Gram" ${unit==="Gram"?"selected":""}>Gram</option>
        <option value="Litre" ${unit==="Litre"?"selected":""}>Litre</option>
        <option value="ml" ${unit==="ml"?"selected":""}>ml</option>
        <option value="Piece" ${unit==="Piece"?"selected":""}>Piece</option>
        <option value="Bag" ${unit==="Bag"?"selected":""}>Bag</option>
        <option value="Packet" ${unit==="Packet"?"selected":""}>Packet</option>
      </select>
    `,
    showCancelButton: true,
    confirmButtonText: "Save",
    didOpen: () => {
      const catSel = document.getElementById("sw_category");
      const prodSel = document.getElementById("sw_name");
      // initial fill with old values
      populateProductSelect(catSel.value, prodSel, name);
      catSel.addEventListener("change", () => {
        populateProductSelect(catSel.value, prodSel);
      });
    },
    preConfirm: async () => {
      const c = document.getElementById("sw_category").value.trim();
      const n = document.getElementById("sw_name").value.trim();
      const u = document.getElementById("sw_unit").value.trim();

      if(!c || !n || !u){
        Swal.showValidationMessage("All fields are required.");
        return false;
      }

      if(await duplicateProductCheck(c, n, u, id)){
        Swal.showValidationMessage("This product already exists.");
        return false;
      }

      return { category:c, name:n, unit:u };
    }
  });

  if (!data) return;

  await updateDoc(doc(db,"products",id), data);
  Swal.fire("Updated!", "Product updated successfully.", "success");
  loadProducts();
};

/* DELETE */
window.deleteProduct = async function(id){
  const res = await Swal.fire({
    title: "Delete Product?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Delete"
  });

  if(!res.isConfirmed) return;

  await deleteDoc(doc(db,"products",id));
  loadProducts();
  Swal.fire("Deleted!", "", "success");
};

/* SAVE PRODUCT (Add only, edit popup se hoga) */
saveBtn.addEventListener("click", async () => {

  const category = catSelect.value.trim();
  const name = nameSelect.value.trim();
  const unit = unitSelect.value.trim();

  if (!category || !name || !unit) {
    Swal.fire("Missing!", "All fields are required.", "warning");
    return;
  }

  startLoad();

  if (await duplicateProductCheck(category, name, unit, null)) {
    stopLoad();
    Swal.fire("Duplicate!", "This product already exists.", "error");
    return;
  }

  const data = { category, name, unit };

  await addDoc(productCol, data);

  catSelect.value = "";
  nameSelect.innerHTML = `<option value="">Select Category first</option>`;
  nameSelect.disabled = true;
  unitSelect.value = "";

  stopLoad();
  loadProducts();

  Swal.fire("Saved!", "Product saved successfully!", "success");
});

/* INIT STATE */
populateProductSelect("", nameSelect);
loadProducts();
</script>

</body>
</html>
